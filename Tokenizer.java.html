<!DOCTYPE html><html><body><pre style="background: black; color: #BCBCBC;"><span style="color: #D27428;">package </span>co.gyeongmin.lang.javalang;

<span style="color: #D27428;">import </span>java.util*;
<span style="color: #D27428;">import </span>java.util.function.Supplier;
<span style="color: #D27428;">import </span>java.util.stream.Collectors;
<span style="color: #D27428;">public </span><span style="color: #D27428;">class </span>Tokenizer {
    <span style="color: #D27428;">static </span><span style="color: #D27428;">class </span>Pair&lt;K, V&gt; {
        <span style="color: #D27428;">final </span>K key;
        <span style="color: #D27428;">final </span>V value;
        Pair(K key, V value) <a class="foldable-block"><span style="color: #00b800;">{</span>
            <span style="color: #D27428;">this</span>.key = key;
            <span style="color: #D27428;">this</span>.value = value;
        <span style="color: #00b800;">}</span></a>
        K getKey() <a class="foldable-block"><span style="color: #00b800;">{</span>
            <span style="color: #D27428;">return </span>key;
        <span style="color: #00b800;">}</span></a>
        V getValue() <a class="foldable-block"><span style="color: #00b800;">{</span>
            <span style="color: #D27428;">return </span>value;
        <span style="color: #00b800;">}</span></a>
    }
    
    <span style="color: #D27428;">private </span><span style="color: #D27428;">static </span><span style="color: #D27428;">class </span>Node {
        <span style="color: #D27428;">private </span><span style="color: #D27428;">final </span>String prefix;
        <span style="color: #D27428;">private </span><span style="color: #D27428;">boolean</span> isTerminal;
        <span style="color: #D27428;">private </span>JavaTokenEnum tokenEnum;
        <span style="color: #D27428;">private </span><span style="color: #D27428;">boolean</span> flush;
        <span style="color: #D27428;">private </span>Node fail;
        <span style="color: #D27428;">private </span><span style="color: #D27428;">final </span>HashMap&lt;Character, Node&gt; next = <span style="color: #D27428;">new </span><span style="font-weight: bold; color: #e8e4d6">HashMap</span>&lt;&gt;();
        Node(String prefix) <a class="foldable-block"><span style="color: #00b800;">{</span>
            <span style="color: #D27428;">this</span>.prefix = prefix;
            <span style="color: #D27428;">this</span>.isTerminal = <span style="color: #D27428;">false</span>;
        <span style="color: #00b800;">}</span></a>
        void setTerminal(JavaTokenEnum e) <a class="foldable-block"><span style="color: #00b800;">{</span>
            <span style="color: #D27428;">this</span>.isTerminal = <span style="color: #D27428;">true</span>;
            <span style="color: #D27428;">this</span>.tokenEnum = e;
        <span style="color: #00b800;">}</span></a>
        Node getOrPut(<span style="color: #D27428;">char</span> ch, Supplier&lt;Node&gt; nodeCreator) <a class="foldable-block"><span style="color: #00b800;">{</span>
            <span style="color: #D27428;">if </span>(!next.containsKey(ch)) <a class="foldable-block"><span style="color: #00b800;">{</span>
                next.put(ch, nodeCreator.get());
            <span style="color: #00b800;">}</span></a> 
            <span style="color: #D27428;">return </span>next.get(ch);
        <span style="color: #00b800;">}</span></a>
    }
    
    <span style="color: #D27428;">private </span><span style="color: #D27428;">final </span>Node root = <span style="color: #D27428;">new </span><span style="font-weight: bold; color: #e8e4d6">Node</span>(<span style="color: #477944;">"ROOT"</span>);
    <span style="color: #D27428;">private </span><span style="color: #D27428;">static </span><span style="color: #D27428;">final </span>Tokenizer tokenizer;
    <span style="color: #D27428;">static </span><a class="foldable-block"><span style="color: #00b800;">{</span>
        tokenizer = <span style="color: #D27428;">new </span><span style="font-weight: bold; color: #e8e4d6">Tokenizer</span>();
        <span style="color: #D27428;">for </span>(JavaTokenEnum value: JavaTokenEnum.values()) <a class="foldable-block"><span style="color: #00b800;">{</span>
            <span style="color: #D27428;">if </span>(value.isKeyword) <span style="color: #D27428;">continue</span>;
            
            tokenizer.insertToken(value);
        <span style="color: #00b800;">}</span></a>
        tokenizer.buildFail();
    <span style="color: #00b800;">}</span></a>
    
    <span style="color: #D27428;">private </span>void insertToken(JavaTokenEnum e) <a class="foldable-block"><span style="color: #00b800;">{</span>
        Node elem = root;
        String word = e.value;
        <span style="color: #D27428;">for </span>(<span style="color: #D27428;">int</span> i = <span style="color: #3986AF;">0</span>; i < word.length(); i++) <a class="foldable-block"><span style="color: #00b800;">{</span>
            <span style="color: #D27428;">char</span> ch = word.charAt(i);
            <span style="color: #D27428;">int</span> invariantIdx = i;
            elem = elem.getOrPut(ch, () -> <span style="color: #D27428;">new </span><span style="font-weight: bold; color: #e8e4d6">Node</span>(word.substring(<span style="color: #3986AF;">0</span>, invariantIdx + <span style="color: #3986AF;">1</span>)));
            <span style="color: #D27428;">if </span>(i == <span style="color: #3986AF;">0</span>) elem.flush = <span style="color: #D27428;">true</span>;
            
        <span style="color: #00b800;">}</span></a>
        elem.setTerminal(e);
    <span style="color: #00b800;">}</span></a>
    <span style="color: #D27428;">private </span>void buildFail() <a class="foldable-block"><span style="color: #00b800;">{</span>
        Queue&lt;Node&gt; nodeQueue = <span style="color: #D27428;">new </span><span style="font-weight: bold; color: #e8e4d6">LinkedList</span>&lt;&gt;();
        root.next.values().forEach((node) -> <a class="foldable-block"><span style="color: #00b800;">{</span>
            node.fail = root;
            nodeQueue.add(node);
        <span style="color: #00b800;">}</span></a>);
        <span style="color: #D27428;">while </span>(!nodeQueue.isEmpty()) <a class="foldable-block"><span style="color: #00b800;">{</span>
            Node n = nodeQueue.poll();
            n.next.forEach((ch, node) -> <a class="foldable-block"><span style="color: #00b800;">{</span>
                node.fail = n.fail.next.getOrDefault(ch, root);
                nodeQueue.add(node);
            <span style="color: #00b800;">}</span></a>);
        <span style="color: #00b800;">}</span></a>
    <span style="color: #00b800;">}</span></a>
    <span style="color: #D27428;">private </span><span style="color: #D27428;">static </span><span style="color: #D27428;">final </span>Set&lt;Character&gt; WHITESPACES = <span style="color: #477944;">"\t\n "</span>.chars().mapToObj(c -> (<span style="color: #D27428;">char</span>)c).collect(Collectors.toSet());
    <span style="color: #D27428;">private </span><span style="color: #D27428;">static </span><span style="color: #D27428;">boolean</span> eqCharArray(<span style="color: #D27428;">char</span>[] codes, <span style="color: #D27428;">int</span> j, <span style="color: #D27428;">char</span>[] untilChar) <a class="foldable-block"><span style="color: #00b800;">{</span>
        <span style="color: #D27428;">if </span>(codes.length - j < untilChar.length) <span style="color: #D27428;">return </span><span style="color: #D27428;">false</span>
        ;
        <span style="color: #D27428;">for </span>(<span style="color: #D27428;">int</span> i = <span style="color: #3986AF;">0</span>; i < untilChar.length; i++) <a class="foldable-block"><span style="color: #00b800;">{</span>
            <span style="color: #D27428;">if </span>(codes[j + i] != untilChar[i]) <span style="color: #D27428;">return </span><span style="color: #D27428;">false</span>
            ;
        <span style="color: #00b800;">}</span></a>
        <span style="color: #D27428;">return </span><span style="color: #D27428;">true</span>;
    <span style="color: #00b800;">}</span></a>
    <span style="color: #D27428;">private </span><span style="color: #D27428;">static </span>Pair&lt;JavaToken, Integer&gt; takeUntil(<span style="color: #D27428;">char</span>[] codes, <span style="color: #D27428;">int</span> i, Node elem) <a class="foldable-block"><span style="color: #00b800;">{</span>
        <span style="color: #D27428;">final </span><span style="color: #D27428;">boolean</span> allowEscape = elem.tokenEnum.allowEscape;
        <span style="color: #D27428;">final </span><span style="color: #D27428;">char</span>[] untilChar = elem.tokenEnum.until.toCharArray();
        <span style="color: #D27428;">int</span> j = i;
        <span style="color: #D27428;">boolean</span> escape = <span style="color: #D27428;">false</span>;
        <span style="color: #D27428;">final </span>StringBuilder buf = <span style="color: #D27428;">new </span><span style="font-weight: bold; color: #e8e4d6">StringBuilder</span>();
        buf.append(elem.prefix);
        <span style="color: #D27428;">while </span>(j < codes.length && ((allowEscape && escape) || !eqCharArray(codes, j, untilChar))) <a class="foldable-block"><span style="color: #00b800;">{</span>
            <span style="color: #D27428;">if </span>(escape) escape = <span style="color: #D27428;">false</span>;
            <span style="color: #D27428;">else if </span>(codes[j] == <span style="color: #477944;">'\\'</span>) escape = <span style="color: #D27428;">true</span>;
            
            
            buf.append(codes[j]);
            j++;
        <span style="color: #00b800;">}</span></a>
        <span style="color: #D27428;">if </span>(j < codes.length && untilChar.length > <span style="color: #3986AF;">1</span> || !WHITESPACES.contains(untilChar[<span style="color: #3986AF;">0</span>])) <a class="foldable-block"><span style="color: #00b800;">{</span>
            buf.append(untilChar);
        <span style="color: #00b800;">}</span></a> 
        <span style="color: #D27428;">final </span>JavaToken ret = <span style="color: #D27428;">new </span><span style="font-weight: bold; color: #e8e4d6">JavaToken</span>(elem.tokenEnum.saveTo, buf.toString(), j);
        <span style="color: #D27428;">return </span><span style="color: #D27428;">new </span><span style="font-weight: bold; color: #e8e4d6">Pair</span>&lt;&gt;(ret, j + untilChar.length - <span style="color: #3986AF;">1</span>);
    <span style="color: #00b800;">}</span></a>
    <span style="color: #D27428;">public </span><span style="color: #D27428;">static </span>List&lt;JavaToken&gt; tokenize(String code) <a class="foldable-block"><span style="color: #00b800;">{</span>
        <span style="color: #D27428;">final </span><span style="color: #D27428;">char</span>[] codes = code.toCharArray();
        <span style="color: #D27428;">final </span>List&lt;JavaToken&gt; ret = <span style="color: #D27428;">new </span><span style="font-weight: bold; color: #e8e4d6">ArrayList</span>&lt;&gt;();
        Node elem = tokenizer.root;
        StringBuilder sb = <span style="color: #D27428;">new </span><span style="font-weight: bold; color: #e8e4d6">StringBuilder</span>();
        <span style="color: #D27428;">for </span>(<span style="color: #D27428;">int</span> i = <span style="color: #3986AF;">0</span>; i < codes.length; i++) <a class="foldable-block"><span style="color: #00b800;">{</span>
            <span style="color: #D27428;">char</span> ch = codes[i];
            <span style="color: #D27428;">if </span>(elem.next.containsKey(ch)) <a class="foldable-block"><span style="color: #00b800;">{</span>
                elem = elem.next.get(ch);
                <span style="color: #D27428;">if </span>(elem.flush && sb.length() > <span style="color: #3986AF;">0</span>) <a class="foldable-block"><span style="color: #00b800;">{</span>
                    ret.add(JavaToken.newToken(sb.toString(), i));
                    sb = <span style="color: #D27428;">new </span><span style="font-weight: bold; color: #e8e4d6">StringBuilder</span>();
                <span style="color: #00b800;">}</span></a> 
                sb.append(ch);
            <span style="color: #00b800;">}</span></a> <span style="color: #D27428;">else </span><a class="foldable-block"><span style="color: #00b800;">{</span>
                <span style="color: #D27428;">if </span>(elem.isTerminal) <a class="foldable-block"><span style="color: #00b800;">{</span>
                    <span style="color: #D27428;">if </span>(elem.tokenEnum.takeUntil) <a class="foldable-block"><span style="color: #00b800;">{</span>
                        <span style="color: #D27428;">final </span>Pair&lt;JavaToken, Integer&gt; tokenWithIdx = takeUntil(codes, i, elem);
                        ret.add(tokenWithIdx.getKey());
                        i = tokenWithIdx.getValue();
                        elem = tokenizer.root;
                        sb = <span style="color: #D27428;">new </span><span style="font-weight: bold; color: #e8e4d6">StringBuilder</span>();
                        <span style="color: #D27428;">continue</span>;
                    <span style="color: #00b800;">}</span></a> <span style="color: #D27428;">else </span><a class="foldable-block"><span style="color: #00b800;">{</span>
                        ret.add(<span style="color: #D27428;">new </span><span style="font-weight: bold; color: #e8e4d6">JavaToken</span>(elem.tokenEnum, elem.prefix, i));
                    <span style="color: #00b800;">}</span></a>
                    sb = <span style="color: #D27428;">new </span><span style="font-weight: bold; color: #e8e4d6">StringBuilder</span>();
                <span style="color: #00b800;">}</span></a> 
                <span style="color: #D27428;">if </span>(WHITESPACES.contains(ch)) <a class="foldable-block"><span style="color: #00b800;">{</span>
                    <span style="color: #D27428;">if </span>(sb.length() > <span style="color: #3986AF;">0</span>) <a class="foldable-block"><span style="color: #00b800;">{</span>
                        ret.add(JavaToken.newToken(sb.toString(), i));
                    <span style="color: #00b800;">}</span></a> 
                    sb = <span style="color: #D27428;">new </span><span style="font-weight: bold; color: #e8e4d6">StringBuilder</span>();
                    <span style="color: #D27428;">while </span>(i + <span style="color: #3986AF;">1</span> < codes.length && WHITESPACES.contains(codes[i + <span style="color: #3986AF;">1</span>])) <a class="foldable-block"><span style="color: #00b800;">{</span>
                        i++;
                    <span style="color: #00b800;">}</span></a>
                    elem = tokenizer.root;
                <span style="color: #00b800;">}</span></a> <span style="color: #D27428;">else </span><a class="foldable-block"><span style="color: #00b800;">{</span>
                    sb.append(ch);
                    <span style="color: #D27428;">while </span>(elem != tokenizer.root && !elem.next.containsKey(ch)) <a class="foldable-block"><span style="color: #00b800;">{</span>
                        elem = elem.fail;
                    <span style="color: #00b800;">}</span></a>
                    <span style="color: #D27428;">if </span>(elem.next.containsKey(ch)) <a class="foldable-block"><span style="color: #00b800;">{</span>
                        elem = elem.next.get(ch);
                    <span style="color: #00b800;">}</span></a> 
                <span style="color: #00b800;">}</span></a>
            <span style="color: #00b800;">}</span></a>
        <span style="color: #00b800;">}</span></a>
        <span style="color: #D27428;">if </span>(sb.length() > <span style="color: #3986AF;">0</span>) <a class="foldable-block"><span style="color: #00b800;">{</span>
            ret.add(JavaToken.newToken(sb.toString(), codes.length));
        <span style="color: #00b800;">}</span></a> 
        <span style="color: #D27428;">return </span>ret;
    <span style="color: #00b800;">}</span></a>
}
</body></html></pre>